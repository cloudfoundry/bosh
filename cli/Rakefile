# Copyright (c) 2009-2012 VMware, Inc.

$:.unshift(File.expand_path("../../rake", __FILE__))

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __FILE__)

require "rubygems"
require "bundler"
Bundler.setup(:default, :test)

require "bundler_task"

BundlerTask.new

desc "Run specs"
task "spec" => [ "bundler:install:test", "test:spec" ]

desc "Run specs for CI"
task "spec:ci" => ["bundler:install:test", "test:spec:ci"]

desc "Run specs w/coverage"
task "spec:rcov" => ["bundler:install:test", "test:spec:rcov"]

gem_helper = Bundler::GemHelper.new(Dir.pwd)

desc "Build BOSH CLI gem into the pkg directory"
task "build" do
  gem_helper.build_gem
end

desc "Build and install BOSH CLI into system gems"
task "install_head" do
  Rake::Task["bundler:install"].invoke
  gem_helper.install_gem
end

desc "Install latest stable version into system gems"
task "install" do
  Rake::Task["bundler:install"].invoke
  Bundler.with_clean_env do
    system("gem install bosh_cli-current.gem")
  end
end

namespace "test" do
  ["spec", "spec:rcov", "spec:ci" ].each do |task_name|
    task task_name do
      sh("cd spec && bundle exec rake #{task_name}")
    end
  end
end
